{% extends 'base_template.html' %}
{% load static %}

{% block head_js %}
<style>
    .status-message {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .alert {
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert-danger {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        transition: all 0.2s;
    }

    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .scrollable-cards {
        max-height: 600px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block top_nav %}
<!-- Status Messages -->
<div id="statusMessages" class="status-message"></div>
<!-- TOP NAV -->
<header class="fixed top-0 left-0 right-0 h-14 border-b bg-white flex items-center px-4 justify-between z-40">
    <div class="flex items-center gap-3">
        <button id="menuBtn" class="lg:hidden p-2 rounded-md hover:bg-gray-100">
            ☰
        </button>
        <h1 class="font-semibold text-lg">Accounting Receivable Report</h1>
    </div>

    <div class="flex items-center gap-4">
        <input type="text" placeholder="Search or type a command" class="hidden md:block w-64 px-4 py-1.5 rounded-md border text-sm focus:ring-1 focus:ring-gray-300" />
        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white">
            {{ user.username|slice:":2"|upper }}
        </div>
        <button id="logoutBtn" class="p-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="color:#f7f7f7;">
                <g fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <path d="M16 17l5-5-5-5" />
                    <path d="M21 12H9" />
                </g>
            </svg></button>
    </div>
</header>
{% endblock %}

{% block side_nav %}
{% include 'base_accounting_sidenav.html' %}
{% endblock %}

{% block main_content %}

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <h2 class="font-semibold mb-2 text-sm">Total Receivables</h2>
        <div class="text-xl font-bold text-blue-600" id="total-amount">Rp. 0,00</div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <h2 class="font-semibold mb-2 text-sm">Pending Amount</h2>
        <div class="text-xl font-bold text-orange-600" id="total-pending">Rp. 0,00</div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <h2 class="font-semibold mb-2 text-sm">Total Records</h2>
        <div class="text-xl font-bold text-green-600" id="total-count">0</div>
    </div>
</div>

<!-- Receivables List -->
<h2 class="text-xl font-semibold mb-4">Receivable Payments</h2>

<div class="bg-white rounded-lg shadow-sm p-6">
    <div id="loadingState" class="text-center py-8">
        <div class="inline-flex items-center">
            <svg class="w-6 h-6 mr-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
            Loading receivables...
        </div>
    </div>

    <div id="receivablesContainer" class="scrollable-cards hidden">
        <div id="receivablesList" class="space-y-4">
            <!-- Cards will be inserted here -->
        </div>
        <div id="noData" class="text-center py-8 text-gray-500 hidden">
            No receivable payments found.
        </div>
    </div>
</div>

<script>
    // API Base URLs
    const RECEIVABLE_API_BASE = '{% url "receivable_api" %}';

    // Utility functions
    function showMessage(message, type = 'success') {
        const messagesDiv = document.getElementById('statusMessages');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        messagesDiv.innerHTML = `
        <div class="alert ${alertClass}" role="alert">
            ${message}
            <button type="button" class="ml-4 text-gray-400 hover:text-gray-600" onclick="this.parentElement.remove()">×</button>
        </div>
    `;
        setTimeout(() => messagesDiv.innerHTML = '', 5000);
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function getStatusColor(status) {
        if (status.toLowerCase().includes('paid')) return 'bg-green-100 text-green-800';
        if (status.toLowerCase().includes('unpaid')) return 'bg-red-100 text-red-800';
        return 'bg-gray-100 text-gray-800';
    }

    // Load receivables
    async function loadReceivables() {
        try {
            const response = await fetch(RECEIVABLE_API_BASE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({ action: 'list' })
            });

            const result = await response.json();

            if (result.success) {
                updateSummary(result.data);
                renderReceivables(result.data.receivables);
                showMessage('Receivables loaded successfully');
            } else {
                showMessage(result.message || 'Failed to load receivables', 'error');
            }
        } catch (error) {
            showMessage('Failed to load receivables', 'error');
            console.error('Error loading receivables:', error);
        }
    }

    function updateSummary(data) {
        document.getElementById('total-amount').textContent = data.total_amount;
        document.getElementById('total-pending').textContent = data.total_pending;
        document.getElementById('total-count').textContent = data.count;
    }

    function renderReceivables(receivables) {
        const container = document.getElementById('receivablesList');
        const noData = document.getElementById('noData');

        if (receivables.length === 0) {
            container.innerHTML = '';
            noData.classList.remove('hidden');
            return;
        }

        noData.classList.add('hidden');
        container.innerHTML = '';

        receivables.forEach(receivable => {
            const card = document.createElement('div');
            card.className = 'card p-4';
            card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Rp. ${receivable.amount}</h3>
                    <p class="text-sm text-gray-600">Due: ${formatDate(receivable.due_date)}</p>
                </div>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(receivable.status)}">
                    ${receivable.status}
                </span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">Payment Term:</span>
                    <span class="text-gray-600">${receivable.term}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">Created By:</span>
                    <span class="text-gray-600">${receivable.created_by}</span>
                </div>
                <div class="col-span-2">
                    <span class="font-medium text-gray-700">Created At:</span>
                    <span class="text-gray-600">${formatDate(receivable.created_at)}</span>
                </div>
            </div>
        `;
            container.appendChild(card);
        });
    }

    function logoutAccount() {
        window.location.href = '{% url "logout" %}';
    }

    // Event listeners
    document.getElementById('logoutBtn').addEventListener('click', logoutAccount);

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('receivablesContainer').classList.add('hidden');
        loadReceivables().finally(() => {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('receivablesContainer').classList.remove('hidden');
        });
    });
</script>

{% endblock %}